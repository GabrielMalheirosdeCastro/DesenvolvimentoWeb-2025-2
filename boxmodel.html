<!DOCTYPE html>
<html lang="pt-BR" class="html-page">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Adivinha a Nave Espacial | Gabriel Malheiros FAESA</title>
    
    <!-- CSS do sistema existente para manter consist√™ncia -->
    <link rel="stylesheet" href="style.css">
    
    <!-- CSS espec√≠fico do Box Model para este jogo -->
    <link rel="stylesheet" href="boxmodel.css">
    
    <meta name="description" content="Jogo de adivinha√ß√£o de naves espaciais - Teste seus conhecimentos sobre naves de Star Wars, Halo e LEGO!">
    <meta name="author" content="Gabriel Malheiros de Castro - FAESA 2025-2">
    <script src="security-init.js"></script>
  </head>
<body class="html-page boxmodel-game-page">
    <!-- üöÄ Container Principal do Jogo -->
    <div class="game-container">
        <!-- üéØ Cabe√ßalho do Jogo -->
        <header class="game-header">
            <h1 class="game-title">
                üöÄ Adivinha a Nave Espacial
            </h1>
            <p class="game-subtitle">
                Teste seus conhecimentos sobre naves espaciais de diferentes universos!
            </p>
            
            <!-- üìä Placar e Estat√≠sticas -->
            <div class="score-board">
                <div class="score-item">
                    <span class="score-label">Pontua√ß√£o:</span>
                    <span class="score-value" id="current-score">0</span>
                </div>
                <div class="score-item">
                    <span class="score-label">Acertos:</span>
                    <span class="score-value" id="correct-answers">0</span>
                </div>
                <div class="score-item">
                    <span class="score-label">Total:</span>
                    <span class="score-value" id="total-attempts">0</span>
                </div>
            </div>
        </header>

        <!-- üéÆ √Årea Principal do Jogo -->
        <main class="game-main">
            <!-- üñºÔ∏è Container da Imagem com Box Model -->
            <section class="image-section">
                <div class="image-container" id="image-container">
                    <div class="image-frame">
                        <img id="spaceship-image" 
                             src="" 
                             alt="Nave espacial para adivinha√ß√£o" 
                             class="spaceship-image"
                             style="display: none;">
                        
                        <!-- Loading placeholder -->
                        <div class="image-placeholder" id="image-placeholder">
                            <div class="placeholder-icon">üöÄ</div>
                            <div class="placeholder-text">Carregando pr√≥xima nave...</div>
                        </div>
                        
                        <!-- Error fallback -->
                        <div class="image-error" id="image-error" style="display: none;">
                            <div class="error-icon">‚ùå</div>
                            <div class="error-text">Erro ao carregar imagem</div>
                        </div>
                    </div>
                    
                    <!-- üìù Informa√ß√µes da Categoria -->
                    <div class="category-hint" id="category-hint">
                        <span class="hint-label">Categoria:</span>
                        <span class="hint-value" id="category-value">-</span>
                    </div>
                </div>
            </section>

            <!-- üéØ √Årea de Resposta -->
            <section class="answer-section">
                <div class="answer-container">
                    <div class="question-text">
                        <h2>Qual √© o nome desta nave espacial?</h2>
                        <p class="question-subtitle">Digite sua resposta abaixo:</p>
                    </div>
                    
                    <!-- üìù Input de Resposta -->
                    <div class="input-container">
                        <input type="text" 
                               id="answer-input" 
                               class="answer-input" 
                               placeholder="Digite o nome da nave..."
                               autocomplete="off"
                               maxlength="50">
                        
                        <button id="submit-answer" class="submit-button" type="button">
                            <span class="button-text">Responder</span>
                            <span class="button-icon">‚ú®</span>
                        </button>
                    </div>
                    
                    <!-- üí° Dicas -->
                    <div class="hints-container" id="hints-container" style="display: none;">
                        <h3 class="hints-title">üí° Dicas:</h3>
                        <ul class="hints-list" id="hints-list">
                            <!-- Dicas ser√£o inseridas dinamicamente -->
                        </ul>
                        <button id="show-hint" class="hint-button">
                            Mostrar Dica
                        </button>
                    </div>
                </div>
            </section>

            <!-- ‚úÖ‚ùå √Årea de Feedback -->
            <section class="feedback-section" id="feedback-section" style="display: none;">
                <div class="feedback-container">
                    <div class="feedback-content" id="feedback-content">
                        <!-- Feedback ser√° inserido dinamicamente -->
                    </div>
                    
                    <div class="feedback-actions">
                        <button id="next-question" class="next-button">
                            Pr√≥xima Nave üöÄ
                        </button>
                        <button id="reveal-info" class="info-button">
                            Ver Detalhes üìñ
                        </button>
                    </div>
                </div>
            </section>

            <!-- üìñ Informa√ß√µes Detalhadas -->
            <section class="details-section" id="details-section" style="display: none;">
                <div class="details-container">
                    <h3 class="details-title">üìñ Informa√ß√µes da Nave</h3>
                    <div class="details-content" id="details-content">
                        <!-- Detalhes ser√£o inseridos dinamicamente -->
                    </div>
                </div>
            </section>
        </main>

        <!-- üéõÔ∏è Controles do Jogo -->
        <aside class="game-controls">
            <div class="controls-container">
                <h3 class="controls-title">üéõÔ∏è Controles</h3>
                
                <div class="controls-grid">
                    <button id="new-game" class="control-button new-game">
                        <span class="control-icon">üîÑ</span>
                        <span class="control-text">Novo Jogo</span>
                    </button>
                    
                    <button id="skip-question" class="control-button skip">
                        <span class="control-icon">‚è≠Ô∏è</span>
                        <span class="control-text">Pular</span>
                    </button>
                    
                    <button id="toggle-difficulty" class="control-button difficulty">
                        <span class="control-icon">‚öôÔ∏è</span>
                        <span class="control-text">Dificuldade</span>
                    </button>
                    
                    <button id="show-stats" class="control-button stats">
                        <span class="control-icon">üìä</span>
                        <span class="control-text">Estat√≠sticas</span>
                    </button>
                </div>
                
                <!-- üéöÔ∏è Configura√ß√µes -->
                <div class="game-settings" id="game-settings" style="display: none;">
                    <h4>‚öôÔ∏è Configura√ß√µes</h4>
                    <div class="setting-item">
                        <label for="difficulty-select">Dificuldade:</label>
                        <select id="difficulty-select" class="setting-select">
                            <option value="easy">F√°cil (com dicas)</option>
                            <option value="medium" selected>M√©dio (dicas limitadas)</option>
                            <option value="hard">Dif√≠cil (sem dicas)</option>
                        </select>
                    </div>
                    
                    <div class="setting-item">
                        <label for="category-filter">Categoria:</label>
                        <select id="category-filter" class="setting-select">
                            <option value="all">Todas as categorias</option>
                            <option value="star-wars">Star Wars</option>
                            <option value="halo">Halo</option>
                            <option value="lego">LEGO</option>
                        </select>
                    </div>
                </div>
            </div>
        </aside>

        <!-- üìä Modal de Estat√≠sticas -->
        <div class="modal" id="stats-modal" style="display: none;">
            <div class="modal-overlay" id="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">üìä Suas Estat√≠sticas</h3>
                    <button class="modal-close" id="close-stats">√ó</button>
                </div>
                <div class="modal-body" id="stats-content">
                    <!-- Estat√≠sticas ser√£o inseridas dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- üß≠ Navega√ß√£o -->
    <nav class="navigation-section">
        <div class="nav-container">
            <h3 class="nav-title">üß≠ Navega√ß√£o</h3>
            <div class="nav-buttons">
                <a href="index.html" class="nav-button primary">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Portfolio Principal</span>
                </a>
                
                <a href="galeria-lego-naves.html" class="nav-button secondary">
                    <span class="nav-icon">üß±</span>
                    <span class="nav-text">Galeria LEGO</span>
                </a>
                
                <a href="lab-fundamentos-css.html" class="nav-button secondary">
                    <span class="nav-icon">üé®</span>
                    <span class="nav-text">Lab CSS</span>
                </a>
                
                <a href="tipografia.html" class="nav-button secondary">
                    <span class="nav-icon">üìù</span>
                    <span class="nav-text">Tipografia</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- üìú Scripts -->
    <script src="./src/utils/error-handling-system.js"></script>
    <script>
        // üöÄ Dados das naves espaciais
        const spaceshipData = [
            // Naves Star Wars
            {
                id: 'venator-upgraded',
                name: 'Venator Star Destroyer Melhorado',
                image: '/assets/naves-espaciais/Star wars Venator upgraded.jpg',
                category: 'Star Wars',
                difficulty: 'medium',
                hints: ['√â uma nave capital da Rep√∫blica', 'Tem formato triangular', 'Foi usada nas Guerras Clone'],
                description: 'Uma vers√£o aprimorada do ic√¥nico Venator-class Star Destroyer da Rep√∫blica Gal√°ctica.',
                specifications: {
                    length: '1,137 metros',
                    crew: '7,400 soldados clone',
                    armament: 'Turbolasers duplos pesados'
                }
            },
            {
                id: 'venator-standard',
                name: 'Venator Star Destroyer',
                image: '/assets/naves-espaciais/Star wars venator.jpg',
                category: 'Star Wars',
                difficulty: 'easy',
                hints: ['Nave capital da Rep√∫blica', 'Formato triangular ic√¥nico', 'Protagonista nas Guerras Clone'],
                description: 'O backbone da frota da Rep√∫blica durante as Guerras Clone.',
                specifications: {
                    length: '1,137 metros',
                    crew: '7,400 soldados clone',
                    armament: 'Turbolasers e canh√µes de √≠ons'
                }
            },
            {
                id: 'acclamator',
                name: 'Acclamator Assault Ship',
                image: '/assets/naves-espaciais/starwars acclamator 2.jpg',
                category: 'Star Wars',
                difficulty: 'hard',
                hints: ['Nave de transporte e assalto', 'Usada pela Rep√∫blica', 'Menor que um Star Destroyer'],
                description: 'Nave de assalto e transporte de tropas da Rep√∫blica.',
                specifications: {
                    length: '752 metros',
                    crew: '700 soldados + 16,000 tropas',
                    armament: 'Turbolasers qu√°druplos'
                }
            },
            // Naves Halo
            {
                id: 'unsc-frigate',
                name: 'UNSC Frigate',
                image: '/assets/naves-espaciais/unsc frigate.jpg',
                category: 'Halo',
                difficulty: 'medium',
                hints: ['Nave da UNSC', 'Universo Halo', 'Classe Frigate'],
                description: 'Nave de guerra da For√ßa Espacial das Na√ß√µes Unidas.',
                specifications: {
                    length: '478 metros',
                    crew: '250-300 tripulantes',
                    armament: 'MAC Gun e m√≠sseis Archer'
                }
            },
            // Naves LEGO
            {
                id: 'mini-nave-1',
                name: 'Mini Nave Alpha',
                image: './src/assets/lego-naves/mini-nave-1.jpg',
                category: 'LEGO',
                difficulty: 'easy',
                hints: ['Mini nave LEGO', 'Primeira da s√©rie', 'Constru√ß√£o compacta'],
                description: 'Primeira mini nave da s√©rie de constru√ß√µes LEGO espaciais.',
                specifications: {
                    size: 'Pequeno (6x4 studs)',
                    pieces: '~25 pe√ßas',
                    colors: 'Vermelho, Cinza, Preto'
                }
            },
            {
                id: 'mini-nave-2',
                name: 'Mini Nave Beta',
                image: './src/assets/lego-naves/mini-nave-2.jpg',
                category: 'LEGO',
                difficulty: 'medium',
                hints: ['Mini nave LEGO', 'Segunda da s√©rie', 'Design mais complexo'],
                description: 'Segunda mini nave com estrutura multi-se√ß√µes mais avan√ßada.',
                specifications: {
                    size: 'M√©dio (8x6 studs)',
                    pieces: '~35 pe√ßas',
                    colors: 'Azul, Cinza, Preto'
                }
            },
            {
                id: 'mini-nave-3',
                name: 'Mini Nave Gamma',
                image: './src/assets/lego-naves/mini-nave-3.jpg',
                category: 'LEGO',
                difficulty: 'hard',
                hints: ['Mini nave LEGO', 'Terceira da s√©rie', 'Design √∫nico'],
                description: 'Terceira e mais avan√ßada mini nave da s√©rie com design assim√©trico.',
                specifications: {
                    size: 'Grande (10x8 studs)',
                    pieces: '~45 pe√ßas',
                    colors: 'Verde, Cinza, Preto'
                }
            }
        ];

        // üöÄ Estado do jogo aprimorado
        let gameState = {
            currentShip: null,
            score: 0,
            correctAnswers: 0,
            totalAttempts: 0,
            difficulty: 'medium',
            categoryFilter: 'all',
            hintsUsed: 0,
            gameHistory: [],
            streak: 0,
            bestStreak: 0,
            startTime: null,
            sessionStats: {
                totalTime: 0,
                averageTime: 0,
                fastestCorrect: null,
                slowestCorrect: null
            },
            performance: {
                imageLoadTimes: [],
                responseAccuracy: [],
                hintEffectiveness: {}
            }
        };

        // üîß Inicializa√ß√£o aprimorada
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando jogo de adivinha√ß√£o de naves espaciais v2.0...');
            
            try {
                // Inicializar elementos
                initializeGame();
                loadNextQuestion();
                
                // Event listeners
                setupEventListeners();
                
                // Sistemas avan√ßados
                initializePerformanceMonitoring();
                setupOfflineDetection();
                loadUserPreferences();
                
                console.log('‚úÖ Jogo inicializado com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                showErrorRecovery('Erro na inicializa√ß√£o do jogo');
            }
        });

        // üîß Inicializar o jogo
        function initializeGame() {
            updateScoreDisplay();
            resetFeedback();
            
            // Carregar configura√ß√µes salvas
            loadSavedStats();
            
            // Inicializar analytics locais
            initializeAnalytics();
            
            // Setup de accessibility
            setupAccessibilityFeatures();
            
            // Sistema de cache de imagens
            initializeImageCache();
        }

        // üìä Sistema de monitoramento de performance
        function initializePerformanceMonitoring() {
            // Monitorar tempo de carregamento de p√°ginas
            if ('PerformanceObserver' in window) {
                const observer = new PerformanceObserver((list) => {
                    for (const entry of list.getEntries()) {
                        if (entry.entryType === 'paint') {
                            console.log(`üé® ${entry.name}: ${entry.startTime.toFixed(2)}ms`);
                        }
                    }
                });
                observer.observe({entryTypes: ['paint']});
            }

            // Detectar mudan√ßas de rede
            if ('connection' in navigator) {
                navigator.connection.addEventListener('change', handleNetworkChange);
            }
        }

        // üåê Sistema de detec√ß√£o offline
        function setupOfflineDetection() {
            window.addEventListener('online', () => {
                showTemporaryMessage('üåê Conex√£o restaurada!', 'success');
                enableOnlineFeatures();
            });

            window.addEventListener('offline', () => {
                showTemporaryMessage('üì± Modo offline ativado', 'warning');
                enableOfflineMode();
            });

            // Verificar status inicial
            if (!navigator.onLine) {
                enableOfflineMode();
            }
        }

        // üíæ Carregar prefer√™ncias do usu√°rio
        function loadUserPreferences() {
            try {
                const prefs = JSON.parse(localStorage.getItem('gamePreferences') || '{}');
                
                // Aplicar tema salvo
                if (prefs.theme) {
                    document.body.classList.add(`theme-${prefs.theme}`);
                }
                
                // Aplicar configura√ß√µes de som
                if (prefs.soundEnabled !== undefined) {
                    gameState.soundEnabled = prefs.soundEnabled;
                }
                
                // Aplicar dificuldade preferida
                if (prefs.preferredDifficulty) {
                    gameState.difficulty = prefs.preferredDifficulty;
                    const difficultySelect = document.getElementById('difficulty-select');
                    if (difficultySelect) difficultySelect.value = prefs.preferredDifficulty;
                }
                
                console.log('‚úÖ Prefer√™ncias carregadas:', prefs);
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao carregar prefer√™ncias:', error);
            }
        }

        // ‚ôø Recursos de acessibilidade
        function setupAccessibilityFeatures() {
            // Suporte a leitor de tela
            const gameArea = document.querySelector('.game-area');
            if (gameArea) {
                gameArea.setAttribute('aria-live', 'polite');
                gameArea.setAttribute('aria-label', '√Årea do jogo de adivinha√ß√£o de naves espaciais');
            }

            // Atalhos do teclado
            document.addEventListener('keydown', handleKeyboardShortcuts);

            // Alto contraste
            if (window.matchMedia('(prefers-contrast: high)').matches) {
                document.body.classList.add('high-contrast');
            }
        }

        // ‚å®Ô∏è Atalhos do teclado
        function handleKeyboardShortcuts(event) {
            const { key, ctrlKey, altKey } = event;
            
            switch (true) {
                case key === 'Enter' && !ctrlKey && !altKey:
                    event.preventDefault();
                    submitAnswer();
                    break;
                    
                case key === 'h' && ctrlKey:
                    event.preventDefault();
                    showHint();
                    break;
                    
                case key === 'n' && ctrlKey:
                    event.preventDefault();
                    loadNextQuestion();
                    break;
                    
                case key === 'r' && ctrlKey:
                    event.preventDefault();
                    resetChallenge();
                    break;
                    
                case key === 's' && ctrlKey:
                    event.preventDefault();
                    showStats();
                    break;
                    
                case key === 'Escape':
                    event.preventDefault();
                    closeAllModals();
                    break;
            }
        }

        // üèÉ‚Äç‚ôÇÔ∏è Sistema de cache de imagens
        function initializeImageCache() {
            // Pre-carregar pr√≥ximas imagens em background
            const imagesToPreload = spaceshipData
                .slice(0, 5)
                .map(ship => ship.image);
                
            imagesToPreload.forEach(imagePath => {
                const img = new Image();
                img.onload = () => console.log(`‚úÖ Imagem pr√©-carregada: ${imagePath}`);
                img.onerror = () => console.warn(`‚ùå Erro ao pr√©-carregar: ${imagePath}`);
                img.src = imagePath;
            });
        }

        // üìä Sistema de analytics local
        function initializeAnalytics() {
            gameState.sessionStats.startTime = Date.now();
            
            // Registrar sess√£o
            const sessions = JSON.parse(localStorage.getItem('gameSessions') || '[]');
            const currentSession = {
                startTime: Date.now(),
                userAgent: navigator.userAgent,
                screenResolution: `${screen.width}x${screen.height}`,
                language: navigator.language
            };
            
            sessions.push(currentSession);
            if (sessions.length > 50) sessions.shift(); // Manter apenas √∫ltimas 50 sess√µes
            
            localStorage.setItem('gameSessions', JSON.stringify(sessions));
        }

        // üîÑ Carregar estat√≠sticas salvas
        function loadSavedStats() {
            try {
                const saved = localStorage.getItem('spaceshipGameStats');
                if (saved) {
                    const stats = JSON.parse(saved);
                    gameState.score = stats.score || 0;
                    gameState.correctAnswers = stats.correctAnswers || 0;
                    gameState.totalAttempts = stats.totalAttempts || 0;
                    gameState.bestStreak = stats.bestStreak || 0;
                    gameState.sessionStats = { ...gameState.sessionStats, ...stats.sessionStats };
                    updateScoreDisplay();
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao carregar estat√≠sticas:', error);
                // Reset para valores padr√£o em caso de corrup√ß√£o
                resetGameState();
            }
        }

        // üéØ Carregar pr√≥xima pergunta aprimorada
        function loadNextQuestion() {
            console.log('üîÑ Carregando pr√≥xima pergunta...');
            
            try {
                gameState.startTime = Date.now();
                
                // Filtrar naves por categoria e dificuldade
                let availableShips = filterShipsByPreferences();
                
                // Evitar repetir a mesma nave nas √∫ltimas 3
                availableShips = avoidRecentShips(availableShips);
                
                if (availableShips.length === 0) {
                    availableShips = spaceshipData; // Fallback
                }
                
                // Selecionar nave com algoritmo inteligente
                const selectedShip = selectShipIntelligently(availableShips);
                gameState.currentShip = selectedShip;
                gameState.hintsUsed = 0;
                
                // Resetar interface
                resetFeedback();
                clearInputField();
                
                // Carregar imagem com fallback
                loadShipImageWithFallback();
                
                // Atualizar interface
                updateChallengeInterface();
                
                // Log analytics
                trackQuestionLoad();
                
                console.log(`‚úÖ Nova nave carregada: ${gameState.currentShip.name}`);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar pergunta:', error);
                showErrorRecovery('Erro ao carregar nova pergunta');
            }
        }

        // üîç Filtrar naves por prefer√™ncias
        function filterShipsByPreferences() {
            let ships = [...spaceshipData];
            
            // Filtro por categoria
            if (gameState.categoryFilter !== 'all') {
                ships = ships.filter(ship => 
                    ship.category.toLowerCase().replace(' ', '-') === gameState.categoryFilter
                );
            }
            
            // Filtro por dificuldade adaptativa
            if (gameState.difficulty !== 'mixed') {
                ships = ships.filter(ship => ship.difficulty === gameState.difficulty);
            } else {
                // Modo adaptativo: ajustar dificuldade baseada na performance
                const accuracy = gameState.totalAttempts > 0 ? 
                    gameState.correctAnswers / gameState.totalAttempts : 0.5;
                    
                if (accuracy > 0.8) {
                    ships = ships.filter(ship => ship.difficulty === 'hard');
                } else if (accuracy < 0.4) {
                    ships = ships.filter(ship => ship.difficulty === 'easy');
                }
            }
            
            return ships;
        }

        // üîÑ Evitar naves recentes
        function avoidRecentShips(ships) {
            const recentShips = gameState.gameHistory
                .slice(-3)
                .map(entry => entry.shipId);
                
            return ships.filter(ship => !recentShips.includes(ship.id));
        }

        // üß† Sele√ß√£o inteligente de nave
        function selectShipIntelligently(ships) {
            // Priorizar naves que o usu√°rio tem mais dificuldade
            const userPerformance = getUserPerformanceData();
            
            // Calcular peso baseado na performance
            const weighedShips = ships.map(ship => ({
                ...ship,
                weight: calculateShipWeight(ship, userPerformance)
            }));
            
            // Selecionar usando distribui√ß√£o ponderada
            return selectWeightedRandom(weighedShips);
        }

        // üìà Obter dados de performance do usu√°rio
        function getUserPerformanceData() {
            const history = gameState.gameHistory;
            const performance = {};
            
            history.forEach(entry => {
                if (!performance[entry.shipId]) {
                    performance[entry.shipId] = { attempts: 0, correct: 0 };
                }
                performance[entry.shipId].attempts++;
                if (entry.correct) performance[entry.shipId].correct++;
            });
            
            return performance;
        }

        // ‚öñÔ∏è Calcular peso da nave
        function calculateShipWeight(ship, userPerformance) {
            const shipPerf = userPerformance[ship.id];
            
            if (!shipPerf) return 1; // Nave nunca vista
            
            const accuracy = shipPerf.correct / shipPerf.attempts;
            
            // Priorizar naves com baixa precis√£o
            return accuracy < 0.5 ? 2 : 0.5;
        }

        // üé≤ Sele√ß√£o ponderada aleat√≥ria
        function selectWeightedRandom(weighedItems) {
            const totalWeight = weighedItems.reduce((sum, item) => sum + item.weight, 0);
            let random = Math.random() * totalWeight;
            
            for (const item of weighedItems) {
                random -= item.weight;
                if (random <= 0) return item;
            }
            
            return weighedItems[0]; // Fallback
        }

        // üñºÔ∏è Carregar imagem com fallback aprimorado
        function loadShipImageWithFallback() {
            const img = document.getElementById('spaceship-image');
            const placeholder = document.getElementById('image-placeholder');
            const errorDiv = document.getElementById('image-error');
            const loadingIndicator = createLoadingIndicator();
            
            // Mostrar indicador de carregamento
            placeholder.style.display = 'flex';
            placeholder.appendChild(loadingIndicator);
            img.style.display = 'none';
            errorDiv.style.display = 'none';
            
            // Registrar tempo de in√≠cio
            const loadStartTime = performance.now();
            
            // Configurar carregamento de imagem
            img.onload = function() {
                const loadTime = performance.now() - loadStartTime;
                gameState.performance.imageLoadTimes.push(loadTime);
                
                placeholder.style.display = 'none';
                img.style.display = 'block';
                
                // Anima√ß√£o de entrada
                img.style.opacity = '0';
                img.style.transform = 'scale(0.9)';
                img.style.transition = 'all 0.3s ease';
                
                setTimeout(() => {
                    img.style.opacity = '1';
                    img.style.transform = 'scale(1)';
                }, 10);
                
                console.log(`‚úÖ Imagem carregada em ${loadTime.toFixed(2)}ms`);
            };
            
            img.onerror = function() {
                const loadTime = performance.now() - loadStartTime;
                
                placeholder.style.display = 'none';
                errorDiv.style.display = 'flex';
                
                // Tentar fallback
                attemptImageFallback(img, errorDiv);
                
                console.error(`‚ùå Erro ao carregar imagem em ${loadTime.toFixed(2)}ms:`, gameState.currentShip.image);
                trackImageError(gameState.currentShip.image, loadTime);
            };
            
            img.src = gameState.currentShip.image;
            img.alt = `Nave espacial: ${gameState.currentShip.name}`;
        }

        // üîÑ Tentar fallback de imagem
        function attemptImageFallback(img, errorDiv) {
            // Tentar URLs de fallback
            const fallbackUrls = [
                gameState.currentShip.image.replace('.jpg', '_alt.jpg'),
                gameState.currentShip.image.replace('.jpg', '.png'),
                './assets/placeholder-spaceship.jpg',
                'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzM3NDE1MSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5hdmUgRXNwYWNpYWw8L3RleHQ+PC9zdmc+'
            ];
            
            let fallbackIndex = 0;
            
            const tryNextFallback = () => {
                if (fallbackIndex < fallbackUrls.length) {
                    const fallbackUrl = fallbackUrls[fallbackIndex];
                    fallbackIndex++;
                    
                    const testImg = new Image();
                    testImg.onload = () => {
                        errorDiv.style.display = 'none';
                        img.src = fallbackUrl;
                        img.style.display = 'block';
                        console.log(`‚úÖ Fallback ${fallbackIndex} funcionou:`, fallbackUrl);
                    };
                    testImg.onerror = tryNextFallback;
                    testImg.src = fallbackUrl;
                } else {
                    // Todos os fallbacks falharam, mostrar erro final
                    showImageErrorWithRecovery();
                }
            };
            
            tryNextFallback();
        }

        // üí´ Criar indicador de carregamento
        function createLoadingIndicator() {
            const loader = document.createElement('div');
            loader.className = 'loading-indicator';
            loader.innerHTML = `
                <div class="spinner"></div>
                <p>Carregando nave espacial...</p>
            `;
            
            loader.style.cssText = `
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
                color: #666;
                font-size: 14px;
            `;
            
            // Adicionar CSS do spinner se n√£o existir
            if (!document.querySelector('#loading-styles')) {
                const style = document.createElement('style');
                style.id = 'loading-styles';
                style.textContent = `
                    .spinner {
                        width: 40px;
                        height: 40px;
                        border: 4px solid #f3f4f6;
                        border-top: 4px solid #3b82f6;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }
                    
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            return loader;
        }

        // üìä Rastrear erro de imagem
        function trackImageError(imagePath, loadTime) {
            const errorLog = JSON.parse(localStorage.getItem('imageErrors') || '[]');
            errorLog.push({
                path: imagePath,
                timestamp: Date.now(),
                loadTime: loadTime,
                userAgent: navigator.userAgent
            });
            
            // Manter apenas √∫ltimos 20 erros
            if (errorLog.length > 20) errorLog.shift();
            
            localStorage.setItem('imageErrors', JSON.stringify(errorLog));
        }

        // üö® Mostrar erro de imagem com recupera√ß√£o
        function showImageErrorWithRecovery() {
            const errorDiv = document.getElementById('image-error');
            errorDiv.innerHTML = `
                <div class="error-content">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message">
                        <h4>Erro ao carregar imagem</h4>
                        <p>N√£o foi poss√≠vel carregar a imagem desta nave espacial.</p>
                        <button onclick="reloadCurrentImage()" class="retry-button">
                            üîÑ Tentar novamente
                        </button>
                        <button onclick="skipToNextShip()" class="skip-button">
                            ‚è≠Ô∏è Pular para pr√≥xima
                        </button>
                    </div>
                </div>
            `;
            
            errorDiv.style.display = 'flex';
        }

        // üîÑ Recarregar imagem atual
        function reloadCurrentImage() {
            loadShipImageWithFallback();
        }

        // ‚è≠Ô∏è Pular para pr√≥xima nave
        function skipToNextShip() {
            showTemporaryMessage('‚è≠Ô∏è Pulando para pr√≥xima nave...', 'info');
            setTimeout(() => {
                loadNextQuestion();
            }, 1000);
        }

        // üí¨ Mostrar mensagem tempor√°ria
        function showTemporaryMessage(message, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.className = `temporary-message ${type}`;
            messageEl.textContent = message;
            
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideInFromRight 0.3s ease;
                font-weight: 500;
            `;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.style.animation = 'slideOutToRight 0.3s ease';
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.parentNode.removeChild(messageEl);
                    }
                }, 300);
            }, 3000);
            
            // Adicionar anima√ß√µes se n√£o existem
            addTemporaryMessageStyles();
        }

        // üé® Adicionar estilos de mensagem tempor√°ria
        function addTemporaryMessageStyles() {
            if (!document.querySelector('#temp-message-styles')) {
                const style = document.createElement('style');
                style.id = 'temp-message-styles';
                style.textContent = `
                    @keyframes slideInFromRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    
                    @keyframes slideOutToRight {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // üîß Atualizar interface do desafio
        function updateChallengeInterface() {
            // Atualizar categoria
            const categoryEl = document.getElementById('category-value');
            if (categoryEl) categoryEl.textContent = gameState.currentShip.category;
            
            // Atualizar progresso
            const progressEl = document.getElementById('progress-indicator');
            if (progressEl) {
                const progress = (gameState.totalAttempts / spaceshipData.length) * 100;
                progressEl.style.width = `${Math.min(progress, 100)}%`;
            }
            
            // Focar no input
            const answerInput = document.getElementById('answer-input');
            if (answerInput) {
                answerInput.focus();
                answerInput.select();
            }
            
            // Atualizar dificuldade visual
            updateDifficultyIndicator();
            
            // Atualizar contador de streak
            updateStreakDisplay();
        }

        // üéØ Atualizar indicador de dificuldade
        function updateDifficultyIndicator() {
            const difficultyEl = document.getElementById('difficulty-indicator');
            if (!difficultyEl) return;
            
            const difficulty = gameState.currentShip.difficulty;
            const colors = {
                easy: '#10b981',
                medium: '#f59e0b', 
                hard: '#ef4444'
            };
            
            const labels = {
                easy: 'F√°cil',
                medium: 'M√©dio',
                hard: 'Dif√≠cil'
            };
            
            difficultyEl.textContent = labels[difficulty];
            difficultyEl.style.background = colors[difficulty];
        }

        // üî• Atualizar display de streak
        function updateStreakDisplay() {
            const streakEl = document.getElementById('streak-counter');
            if (!streakEl) return;
            
            if (gameState.streak > 0) {
                streakEl.textContent = `üî• ${gameState.streak}x`;
                streakEl.style.display = 'inline-block';
                
                // Anima√ß√£o especial para streak alto
                if (gameState.streak >= 5) {
                    streakEl.style.animation = 'pulse 0.5s infinite';
                }
            } else {
                streakEl.style.display = 'none';
            }
        }

        // üßπ Limpar campo de input
        function clearInputField() {
            const answerInput = document.getElementById('answer-input');
            if (answerInput) {
                answerInput.value = '';
                answerInput.classList.remove('input-error', 'input-partial');
            }
        }

        // üìä Rastrear carregamento de pergunta
        function trackQuestionLoad() {
            const questionData = {
                shipId: gameState.currentShip.id,
                shipName: gameState.currentShip.name,
                difficulty: gameState.currentShip.difficulty,
                category: gameState.currentShip.category,
                loadTime: Date.now(),
                sessionTime: Date.now() - gameState.sessionStats.startTime
            };
            
            // Adicionar ao hist√≥rico
            gameState.gameHistory.push(questionData);
            
            // Analytics local
            const analytics = JSON.parse(localStorage.getItem('gameAnalytics') || '{}');
            if (!analytics.questionsLoaded) analytics.questionsLoaded = [];
            
            analytics.questionsLoaded.push(questionData);
            
            // Limitar hist√≥rico
            if (analytics.questionsLoaded.length > 100) {
                analytics.questionsLoaded.shift();
            }
            
            localStorage.setItem('gameAnalytics', JSON.stringify(analytics));
        }

        // üìù Event listeners
        function setupEventListeners() {
            // Resposta
            document.getElementById('submit-answer').addEventListener('click', submitAnswer);
            document.getElementById('answer-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitAnswer();
                }
            });
            
            // Controles
            document.getElementById('new-game').addEventListener('click', newGame);
            document.getElementById('skip-question').addEventListener('click', skipQuestion);
            document.getElementById('next-question').addEventListener('click', loadNextQuestion);
            document.getElementById('reveal-info').addEventListener('click', toggleDetails);
            document.getElementById('show-hint').addEventListener('click', showHint);
            
            // Configura√ß√µes
            document.getElementById('toggle-difficulty').addEventListener('click', toggleSettings);
            document.getElementById('difficulty-select').addEventListener('change', updateDifficulty);
            document.getElementById('category-filter').addEventListener('change', updateCategoryFilter);
            
            // Modal
            document.getElementById('show-stats').addEventListener('click', showStats);
            document.getElementById('close-stats').addEventListener('click', closeStats);
            document.getElementById('modal-overlay').addEventListener('click', closeStats);
        }

        // ‚úÖ Submeter resposta - VERS√ÉO APRIMORADA COM ERROR HANDLING
        function submitAnswer() {
            return window.safeExecute(() => {
                const answer = document.getElementById('answer-input').value.trim();
                
                // üîç Valida√ß√£o de entrada aprimorada
                if (!answer) {
                    showInputError('Por favor, digite uma resposta antes de submeter!');
                    focusAnswerInput();
                    return;
                }
                
                if (answer.length < 2) {
                    showInputError('A resposta deve ter pelo menos 2 caracteres!');
                    focusAnswerInput();
                    return;
                }
                
                // üõ°Ô∏è Sanitiza√ß√£o de entrada
                const sanitizedAnswer = sanitizeInput(answer);
                
                // üéØ Verifica√ß√£o de resposta com feedback detalhado
                const validationResult = checkAnswerAdvanced(sanitizedAnswer);
                const endTime = Date.now();
                const responseTime = gameState.startTime ? endTime - gameState.startTime : 0;
                
                gameState.totalAttempts++;
                
                if (validationResult.isCorrect) {
                    gameState.correctAnswers++;
                    gameState.streak++;
                    gameState.bestStreak = Math.max(gameState.bestStreak, gameState.streak);
                    gameState.score += calculateScoreWithBonus(responseTime);
                    
                    // üìä Analytics de performance
                    trackResponseTime(responseTime, true);
                    showFeedback(true, sanitizedAnswer, validationResult);
                    celebrateCorrectAnswer();
                    
                    // Auto-avan√ßar ap√≥s delay
                    setTimeout(() => loadNextQuestion(), 2000);
                } else {
                    gameState.streak = 0; // Reset streak
                    trackResponseTime(responseTime, false);
                    showFeedback(false, sanitizedAnswer, validationResult);
                    
                    // üí° Sugest√µes inteligentes
                    if (validationResult.suggestions.length > 0) {
                        showSuggestions(validationResult.suggestions);
                    }
                }
                
                updateScoreDisplay();
                saveGameStats();
                logUserActivity(sanitizedAnswer, validationResult.isCorrect, responseTime);
            }, () => {
                // Fallback em caso de erro
                showTemporaryMessage('‚ùå Erro ao processar resposta. Tente novamente.', 'error');
            });
        }
        
        // üõ°Ô∏è Fun√ß√£o de sanitiza√ß√£o de entrada
        function sanitizeInput(input) {
            return input
                .trim()
                .replace(/[^\w\s-]/gi, '') // Remove caracteres especiais
                .replace(/\s+/g, ' ')      // Remove espa√ßos duplos
                .toLowerCase();
        }
        
        // üîç Verifica√ß√£o avan√ßada de resposta
        function checkAnswerAdvanced(answer) {
            const correctName = gameState.currentShip.name.toLowerCase();
            const result = {
                isCorrect: false,
                confidence: 0,
                matchedWords: [],
                suggestions: [],
                feedbackType: 'exact'
            };
            
            // 1Ô∏è‚É£ Verifica√ß√£o exata
            if (answer === correctName) {
                result.isCorrect = true;
                result.confidence = 100;
                result.feedbackType = 'exact';
                return result;
            }
            
            // 2Ô∏è‚É£ Verifica√ß√£o sem acentos e caracteres especiais
            const normalizedCorrect = normalizeText(correctName);
            const normalizedAnswer = normalizeText(answer);
            
            if (normalizedAnswer === normalizedCorrect) {
                result.isCorrect = true;
                result.confidence = 95;
                result.feedbackType = 'normalized';
                return result;
            }
            
            // 3Ô∏è‚É£ Verifica√ß√£o de palavras-chave
            const correctWords = correctName.split(' ').filter(word => word.length > 2);
            const answerWords = answer.split(' ');
            
            let matchedWords = [];
            let totalConfidence = 0;
            
            correctWords.forEach(correctWord => {
                answerWords.forEach(answerWord => {
                    const similarity = calculateSimilarity(correctWord, answerWord);
                    if (similarity > 0.7) {
                        matchedWords.push(correctWord);
                        totalConfidence += similarity;
                    }
                });
            });
            
            result.matchedWords = matchedWords;
            result.confidence = (matchedWords.length / correctWords.length) * 100;
            
            // 4Ô∏è‚É£ Crit√©rio de acerto por palavras-chave
            const requiredMatches = Math.ceil(correctWords.length * 0.6); // 60% das palavras
            if (matchedWords.length >= requiredMatches && result.confidence >= 60) {
                result.isCorrect = true;
                result.feedbackType = 'partial';
            }
            
            // 5Ô∏è‚É£ Gerar sugest√µes se n√£o acertou
            if (!result.isCorrect) {
                result.suggestions = generateSmartSuggestions(answer, correctName);
            }
            
            return result;
        }
        
        // üîß Fun√ß√£o auxiliar para normalizar texto
        function normalizeText(text) {
            return text
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "") // Remove acentos
                .toLowerCase()
                .replace(/[^\w\s]/g, ''); // Remove caracteres especiais
        }
        
        // üìä Calcular similaridade entre strings
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }
        
        // üî¢ Algoritmo de Levenshtein Distance
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        // üí° Gerar sugest√µes inteligentes
        function generateSmartSuggestions(userAnswer, correctAnswer) {
            const suggestions = [];
            const correctWords = correctAnswer.split(' ');
            const userWords = userAnswer.split(' ');
            
            // Sugest√£o 1: Palavras que o usu√°rio esqueceu
            const missingWords = correctWords.filter(word => 
                !userWords.some(userWord => 
                    calculateSimilarity(word, userWord) > 0.5
                )
            );
            
            if (missingWords.length > 0) {
                suggestions.push(`Tente incluir: "${missingWords[0]}"`);
            }
            
            // Sugest√£o 2: Corre√ß√£o de grafia
            correctWords.forEach(correctWord => {
                userWords.forEach(userWord => {
                    const similarity = calculateSimilarity(correctWord, userWord);
                    if (similarity > 0.4 && similarity < 0.8) {
                        suggestions.push(`"${userWord}" ‚Üí "${correctWord}"?`);
                    }
                });
            });
            
            // Sugest√£o 3: Categoria da nave
            if (gameState.currentShip.category) {
                suggestions.push(`√â uma nave da categoria: ${gameState.currentShip.category}`);
            }
            
            return suggestions.slice(0, 2); // M√°ximo 2 sugest√µes
        }
        
        // üéä Efeito visual de comemora√ß√£o
        function celebrateCorrectAnswer() {
            // Criar confetti visual
            const confetti = document.createElement('div');
            confetti.innerHTML = 'üéâüéä‚ú®üåü‚≠ê';
            confetti.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 3rem;
                z-index: 9999;
                pointer-events: none;
                animation: celebrate 2s ease-out forwards;
            `;
            
            document.body.appendChild(confetti);
            
            // Adicionar anima√ß√£o CSS dinamicamente
            if (!document.querySelector('#celebrate-animation')) {
                const style = document.createElement('style');
                style.id = 'celebrate-animation';
                style.textContent = `
                    @keyframes celebrate {
                        0% {
                            transform: translate(-50%, -50%) scale(0) rotate(0deg);
                            opacity: 1;
                        }
                        50% {
                            transform: translate(-50%, -50%) scale(1.5) rotate(180deg);
                            opacity: 1;
                        }
                        100% {
                            transform: translate(-50%, -50%) scale(1) rotate(360deg);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            setTimeout(() => {
                if (confetti.parentNode) {
                    confetti.parentNode.removeChild(confetti);
                }
            }, 2000);
        }
        
        // ‚ùå Mostrar erro de entrada
        function showInputError(message) {
            const answerInput = document.getElementById('answer-input');
            
            // Remover classe de erro anterior
            answerInput.classList.remove('input-error');
            
            // Adicionar classe de erro
            answerInput.classList.add('input-error');
            
            // Criar tooltip de erro
            const errorTooltip = document.createElement('div');
            errorTooltip.className = 'error-tooltip';
            errorTooltip.textContent = message;
            errorTooltip.style.cssText = `
                position: absolute;
                background: #ef4444;
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 14px;
                z-index: 1000;
                top: -45px;
                left: 0;
                white-space: nowrap;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                animation: errorShake 0.5s ease-in-out;
            `;
            
            answerInput.parentNode.style.position = 'relative';
            answerInput.parentNode.appendChild(errorTooltip);
            
            // Adicionar anima√ß√£o de shake
            if (!document.querySelector('#error-animation')) {
                const style = document.createElement('style');
                style.id = 'error-animation';
                style.textContent = `
                    .input-error {
                        border-color: #ef4444 !important;
                        box-shadow: 0 0 10px rgba(239, 68, 68, 0.3) !important;
                    }
                    
                    @keyframes errorShake {
                        0%, 100% { transform: translateX(0); }
                        25% { transform: translateX(-5px); }
                        75% { transform: translateX(5px); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Remover erro ap√≥s 3 segundos
            setTimeout(() => {
                answerInput.classList.remove('input-error');
                if (errorTooltip.parentNode) {
                    errorTooltip.parentNode.removeChild(errorTooltip);
                }
            }, 3000);
        }
        
        // üéØ Focar no campo de resposta
        function focusAnswerInput() {
            const answerInput = document.getElementById('answer-input');
            answerInput.focus();
            answerInput.select();
        }
        
        // üí° Mostrar sugest√µes
        function showSuggestions(suggestions) {
            if (suggestions.length === 0) return;
            
            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.className = 'suggestions-container';
            suggestionsContainer.innerHTML = `
                <div class="suggestions-header">üí° Dicas:</div>
                ${suggestions.map(suggestion => 
                    `<div class="suggestion-item">${suggestion}</div>`
                ).join('')}
            `;
            
            suggestionsContainer.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: rgba(59, 130, 246, 0.9);
                color: white;
                padding: 15px;
                border-radius: 10px;
                max-width: 300px;
                z-index: 1000;
                font-size: 14px;
                backdrop-filter: blur(5px);
                animation: slideInRight 0.3s ease-out;
            `;
            
            document.body.appendChild(suggestionsContainer);
            
            // Auto-remover ap√≥s 5 segundos
            setTimeout(() => {
                if (suggestionsContainer.parentNode) {
                    suggestionsContainer.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        if (suggestionsContainer.parentNode) {
                            suggestionsContainer.parentNode.removeChild(suggestionsContainer);
                        }
                    }, 300);
                }
            }, 5000);
        }
        
        // üìù Log de atividade do usu√°rio aprimorado
        function logUserActivity(answer, wasCorrect, responseTime) {
            return window.safeExecute(() => {
                const activity = {
                    timestamp: new Date().toISOString(),
                    sessionId: sessionStorage.getItem('sessionId') || 'unknown',
                    question: gameState.currentShip.name,
                    questionId: gameState.currentShip.id,
                    userAnswer: answer,
                    correct: wasCorrect,
                    responseTime: responseTime,
                    attempts: gameState.totalAttempts,
                    hintsUsed: gameState.hintsUsed,
                    score: gameState.score,
                    streak: gameState.streak,
                    difficulty: gameState.currentShip.difficulty,
                    category: gameState.currentShip.category,
                    userAgent: navigator.userAgent.substring(0, 100), // Truncar para economia de espa√ßo
                    screenResolution: `${screen.width}x${screen.height}`,
                    isOnline: navigator.onLine
                };
                
                console.log('üìä Atividade do usu√°rio:', activity);
                
                // Salvar hist√≥rico local com backup
                try {
                    const history = JSON.parse(localStorage.getItem('boxmodel-history') || '[]');
                    history.push(activity);
                    
                    // Manter apenas √∫ltimas 100 tentativas
                    if (history.length > 100) {
                        history.splice(0, history.length - 100);
                    }
                    
                    localStorage.setItem('boxmodel-history', JSON.stringify(history));
                    
                    // Backup em sessionStorage
                    const sessionHistory = JSON.parse(sessionStorage.getItem('session-activity') || '[]');
                    sessionHistory.push(activity);
                    sessionStorage.setItem('session-activity', JSON.stringify(sessionHistory));
                    
                } catch (storageError) {
                    // Se localStorage falhar, usar apenas sessionStorage
                    console.warn('‚ö†Ô∏è localStorage indispon√≠vel, usando sessionStorage');
                    const sessionHistory = JSON.parse(sessionStorage.getItem('session-activity') || '[]');
                    sessionHistory.push(activity);
                    sessionStorage.setItem('session-activity', JSON.stringify(sessionHistory));
                }
                
                // Analytics de performance em tempo real
                updatePerformanceMetrics(activity);
                
            }, () => {
                console.warn('‚ö†Ô∏è Erro ao fazer log da atividade do usu√°rio');
            });
        }

        // üîç Verificar resposta
        function checkAnswer(answer) {
            const correctName = gameState.currentShip.name.toLowerCase();
            const userAnswer = answer.toLowerCase();
            
            // Verifica√ß√£o exata
            if (userAnswer === correctName) {
                return true;
            }
            
            // Verifica√ß√£o parcial (palavras-chave)
            const keywords = correctName.split(' ');
            const matchedKeywords = keywords.filter(keyword => 
                userAnswer.includes(keyword) && keyword.length > 2
            );
            
            return matchedKeywords.length >= Math.ceil(keywords.length / 2);
        }

        // üìä Calcular pontua√ß√£o com bonus de tempo
        function calculateScoreWithBonus(responseTime) {
            let baseScore = calculateScore();
            
            // Bonus por velocidade (m√°ximo 50 pontos extras)
            const timeBonus = Math.max(0, 50 - Math.floor(responseTime / 1000));
            
            // Bonus por streak
            const streakBonus = gameState.streak > 1 ? (gameState.streak - 1) * 10 : 0;
            
            return baseScore + timeBonus + streakBonus;
        }

        // ‚è±Ô∏è Rastrear tempo de resposta
        function trackResponseTime(responseTime, wasCorrect) {
            return window.safeExecute(() => {
                const timeData = {
                    time: responseTime,
                    correct: wasCorrect,
                    shipId: gameState.currentShip.id,
                    difficulty: gameState.currentShip.difficulty,
                    timestamp: Date.now()
                };
                
                // Atualizar estat√≠sticas de sess√£o
                gameState.sessionStats.totalTime += responseTime;
                
                if (wasCorrect) {
                    if (!gameState.sessionStats.fastestCorrect || responseTime < gameState.sessionStats.fastestCorrect) {
                        gameState.sessionStats.fastestCorrect = responseTime;
                    }
                    
                    if (!gameState.sessionStats.slowestCorrect || responseTime > gameState.sessionStats.slowestCorrect) {
                        gameState.sessionStats.slowestCorrect = responseTime;
                    }
                }
                
                // Calcular tempo m√©dio
                const correctResponses = gameState.gameHistory.filter(h => h.correct).length;
                if (correctResponses > 0) {
                    gameState.sessionStats.averageTime = gameState.sessionStats.totalTime / correctResponses;
                }
                
                // Analytics local
                const responseAnalytics = JSON.parse(localStorage.getItem('responseAnalytics') || '[]');
                responseAnalytics.push(timeData);
                
                // Manter √∫ltimas 100 respostas
                if (responseAnalytics.length > 100) {
                    responseAnalytics.shift();
                }
                
                localStorage.setItem('responseAnalytics', JSON.stringify(responseAnalytics));
            }, () => {
                console.warn('‚ö†Ô∏è Erro ao rastrear tempo de resposta');
            });
        }

        // üåê Ativar recursos online
        function enableOnlineFeatures() {
            return window.safeExecute(() => {
                // Reabilitar elementos que requerem internet
                const onlineElements = document.querySelectorAll('[data-requires-online]');
                onlineElements.forEach(element => {
                    element.disabled = false;
                    element.style.opacity = '1';
                    element.title = '';
                });

                // Tentar sincronizar dados pendentes
                syncPendingData();
                
                console.log('üåê Recursos online ativados');
            });
        }

        // üì± Ativar modo offline
        function enableOfflineMode() {
            return window.safeExecute(() => {
                // Desabilitar elementos que requerem internet
                const onlineElements = document.querySelectorAll('[data-requires-online]');
                onlineElements.forEach(element => {
                    element.disabled = true;
                    element.style.opacity = '0.5';
                    element.title = 'Requer conex√£o com internet';
                });

                // Mostrar indicador de modo offline
                showOfflineIndicator();
                
                console.log('üì± Modo offline ativado');
            });
        }

        // üì° Sincronizar dados pendentes
        function syncPendingData() {
            return window.safeAsyncExecute(async () => {
                const pendingData = JSON.parse(localStorage.getItem('pendingSync') || '[]');
                
                if (pendingData.length > 0) {
                    console.log(`üì§ Sincronizando ${pendingData.length} itens pendentes...`);
                    
                    // Simular sincroniza√ß√£o (aqui voc√™ enviaria para um servidor)
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Limpar dados pendentes ap√≥s sincroniza√ß√£o
                    localStorage.removeItem('pendingSync');
                    
                    showTemporaryMessage(`‚úÖ ${pendingData.length} itens sincronizados!`, 'success');
                }
            }, async () => {
                console.warn('‚ö†Ô∏è Falha na sincroniza√ß√£o de dados pendentes');
            });
        }

        // üî¥ Mostrar indicador de modo offline
        function showOfflineIndicator() {
            if (document.getElementById('offline-indicator')) return;
            
            const indicator = document.createElement('div');
            indicator.id = 'offline-indicator';
            indicator.innerHTML = 'üì± Modo Offline';
            indicator.style.cssText = `
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                background: #f59e0b;
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 12px;
                z-index: 10000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                animation: fadeInDown 0.3s ease;
            `;
            
            document.body.appendChild(indicator);
        }

        // üîÑ Fun√ß√µes de recupera√ß√£o de erro
        function showErrorRecovery(errorMessage) {
            return window.safeExecute(() => {
                const recoveryModal = document.createElement('div');
                recoveryModal.className = 'error-recovery-modal';
                recoveryModal.innerHTML = `
                    <div class="recovery-content">
                        <div class="recovery-icon">üö®</div>
                        <h3>Oops! Algo deu errado</h3>
                        <p>${errorMessage}</p>
                        <div class="recovery-actions">
                            <button onclick="location.reload()" class="recovery-btn primary">
                                üîÑ Recarregar P√°gina
                            </button>
                            <button onclick="resetGameToSafeState()" class="recovery-btn secondary">
                                üéÆ Reset Seguro
                            </button>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="recovery-btn tertiary">
                                ‚ùå Fechar
                            </button>
                        </div>
                    </div>
                `;
                
                recoveryModal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 20000;
                    animation: fadeIn 0.3s ease;
                `;
                
                document.body.appendChild(recoveryModal);
                addRecoveryModalStyles();
            }, () => {
                // Fallback absoluto
                alert(`Erro cr√≠tico: ${errorMessage}. A p√°gina ser√° recarregada.`);
                location.reload();
            });
        }

        // üé® Adicionar estilos do modal de recupera√ß√£o
        function addRecoveryModalStyles() {
            if (document.getElementById('recovery-modal-styles')) return;
            
            const style = document.createElement('style');
            style.id = 'recovery-modal-styles';
            style.textContent = `
                .recovery-content {
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    text-align: center;
                    max-width: 400px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                }
                
                .recovery-icon {
                    font-size: 48px;
                    margin-bottom: 15px;
                }
                
                .recovery-content h3 {
                    color: #dc2626;
                    margin-bottom: 10px;
                    font-size: 24px;
                }
                
                .recovery-content p {
                    color: #666;
                    margin-bottom: 25px;
                    line-height: 1.5;
                }
                
                .recovery-actions {
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                }
                
                .recovery-btn {
                    padding: 12px 24px;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                }
                
                .recovery-btn.primary {
                    background: #3b82f6;
                    color: white;
                }
                
                .recovery-btn.primary:hover {
                    background: #2563eb;
                    transform: translateY(-2px);
                }
                
                .recovery-btn.secondary {
                    background: #f59e0b;
                    color: white;
                }
                
                .recovery-btn.secondary:hover {
                    background: #d97706;
                }
                
                .recovery-btn.tertiary {
                    background: #6b7280;
                    color: white;
                }
                
                .recovery-btn.tertiary:hover {
                    background: #4b5563;
                }
                
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                
                @keyframes fadeInDown {
                    from { 
                        opacity: 0; 
                        transform: translateX(-50%) translateY(-20px);
                    }
                    to { 
                        opacity: 1; 
                        transform: translateX(-50%) translateY(0);
                    }
                }
            `;
            
            document.head.appendChild(style);
        }

        // üîí Reset para estado seguro
        function resetGameToSafeState() {
            return window.safeExecute(() => {
                // Limpar dados corrompidos
                ['spaceshipGameStats', 'gameAnalytics', 'errorLog'].forEach(key => {
                    localStorage.removeItem(key);
                });
                
                // Reset do estado do jogo
                gameState = {
                    currentShip: null,
                    score: 0,
                    correctAnswers: 0,
                    totalAttempts: 0,
                    difficulty: 'medium',
                    categoryFilter: 'all',
                    hintsUsed: 0,
                    gameHistory: [],
                    streak: 0,
                    bestStreak: 0,
                    startTime: null,
                    sessionStats: {
                        totalTime: 0,
                        averageTime: 0,
                        fastestCorrect: null,
                        slowestCorrect: null
                    },
                    performance: {
                        imageLoadTimes: [],
                        responseAccuracy: [],
                        hintEffectiveness: {}
                    }
                };
                
                // Reinicializar jogo
                initializeGame();
                loadNextQuestion();
                
                // Fechar modal
                const modal = document.querySelector('.error-recovery-modal');
                if (modal) modal.remove();
                
                showTemporaryMessage('‚úÖ Jogo reinicializado com sucesso!', 'success');
            }, () => {
                // Se nem o reset funcionar, for√ßar recarga
                location.reload();
            });
        }

        // ‚ùå Fechar todos os modais
        function closeAllModals() {
            return window.safeExecute(() => {
                const modals = document.querySelectorAll('.modal, .error-recovery-modal, .stats-modal');
                modals.forEach(modal => modal.remove());
            });
        }

        // üîÑ Tratar mudan√ßa de rede
        function handleNetworkChange() {
            return window.safeExecute(() => {
                if (navigator.connection) {
                    const connection = navigator.connection;
                    const effectiveType = connection.effectiveType;
                    
                    console.log(`üåê Rede alterada: ${effectiveType}`);
                    
                    // Ajustar qualidade com base na conex√£o
                    if (effectiveType === 'slow-2g' || effectiveType === '2g') {
                        enableLowBandwidthMode();
                    } else {
                        disableLowBandwidthMode();
                    }
                }
            });
        }

        // üì± Modo baixa largura de banda
        function enableLowBandwidthMode() {
            document.body.classList.add('low-bandwidth');
            showTemporaryMessage('üì± Modo de economia de dados ativado', 'info');
        }

        function disableLowBandwidthMode() {
            document.body.classList.remove('low-bandwidth');
        }

        // üí¨ Mostrar feedback
        function showFeedback(isCorrect, userAnswer) {
            const feedbackSection = document.getElementById('feedback-section');
            const feedbackContent = document.getElementById('feedback-content');
            
            if (isCorrect) {
                feedbackContent.innerHTML = `
                    <div class="feedback-success">
                        <div class="feedback-icon">üéâ</div>
                        <div class="feedback-message">
                            <h3>Parab√©ns! Resposta correta!</h3>
                            <p>Voc√™ acertou: <strong>${gameState.currentShip.name}</strong></p>
                            <p class="score-earned">+${calculateScore()} pontos</p>
                        </div>
                    </div>
                `;
            } else {
                feedbackContent.innerHTML = `
                    <div class="feedback-error">
                        <div class="feedback-icon">üòû</div>
                        <div class="feedback-message">
                            <h3>Resposta incorreta!</h3>
                            <p>Voc√™ disse: <em>"${userAnswer}"</em></p>
                            <p>A resposta correta √©: <strong>${gameState.currentShip.name}</strong></p>
                        </div>
                    </div>
                `;
            }
            
            feedbackSection.style.display = 'block';
        }

        // üí° Mostrar dica
        function showHint() {
            if (gameState.hintsUsed >= gameState.currentShip.hints.length) {
                alert('N√£o h√° mais dicas dispon√≠veis!');
                return;
            }
            
            const hintsContainer = document.getElementById('hints-container');
            const hintsList = document.getElementById('hints-list');
            
            const hint = gameState.currentShip.hints[gameState.hintsUsed];
            const listItem = document.createElement('li');
            listItem.textContent = hint;
            hintsList.appendChild(listItem);
            
            gameState.hintsUsed++;
            hintsContainer.style.display = 'block';
            
            if (gameState.hintsUsed >= gameState.currentShip.hints.length) {
                document.getElementById('show-hint').style.display = 'none';
            }
        }

        // üìñ Toggle detalhes
        function toggleDetails() {
            const detailsSection = document.getElementById('details-section');
            const detailsContent = document.getElementById('details-content');
            
            if (detailsSection.style.display === 'none') {
                detailsContent.innerHTML = generateDetailsHTML();
                detailsSection.style.display = 'block';
            } else {
                detailsSection.style.display = 'none';
            }
        }

        // üìù Gerar HTML dos detalhes
        function generateDetailsHTML() {
            const ship = gameState.currentShip;
            
            let specificationsHTML = '';
            if (ship.specifications) {
                specificationsHTML = '<div class="specifications"><h4>üìä Especifica√ß√µes:</h4><ul>';
                for (const [key, value] of Object.entries(ship.specifications)) {
                    specificationsHTML += `<li><strong>${key}:</strong> ${value}</li>`;
                }
                specificationsHTML += '</ul></div>';
            }
            
            return `
                <div class="ship-details">
                    <h4>${ship.name}</h4>
                    <p><strong>Categoria:</strong> ${ship.category}</p>
                    <p><strong>Dificuldade:</strong> ${ship.difficulty}</p>
                    <div class="description">
                        <h4>üìñ Descri√ß√£o:</h4>
                        <p>${ship.description}</p>
                    </div>
                    ${specificationsHTML}
                </div>
            `;
        }

        // üîÑ Fun√ß√µes de controle
        function newGame() {
            if (confirm('Tem certeza que deseja come√ßar um novo jogo? O progresso atual ser√° perdido.')) {
                gameState.score = 0;
                gameState.correctAnswers = 0;
                gameState.totalAttempts = 0;
                gameState.gameHistory = [];
                updateScoreDisplay();
                loadNextQuestion();
                saveGameStats();
            }
        }

        function skipQuestion() {
            if (confirm('Tem certeza que deseja pular esta pergunta?')) {
                gameState.totalAttempts++;
                updateScoreDisplay();
                loadNextQuestion();
                saveGameStats();
            }
        }

        function toggleSettings() {
            const settings = document.getElementById('game-settings');
            settings.style.display = settings.style.display === 'none' ? 'block' : 'none';
        }

        function updateDifficulty() {
            gameState.difficulty = document.getElementById('difficulty-select').value;
            console.log('Dificuldade alterada para:', gameState.difficulty);
        }

        function updateCategoryFilter() {
            gameState.categoryFilter = document.getElementById('category-filter').value;
            console.log('Filtro de categoria alterado para:', gameState.categoryFilter);
        }

        // üìä Estat√≠sticas
        function showStats() {
            const modal = document.getElementById('stats-modal');
            const content = document.getElementById('stats-content');
            
            const accuracy = gameState.totalAttempts > 0 ? 
                Math.round((gameState.correctAnswers / gameState.totalAttempts) * 100) : 0;
            
            content.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${gameState.score}</div>
                        <div class="stat-label">Pontua√ß√£o Total</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${gameState.correctAnswers}</div>
                        <div class="stat-label">Respostas Corretas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${gameState.totalAttempts}</div>
                        <div class="stat-label">Total de Tentativas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${accuracy}%</div>
                        <div class="stat-label">Taxa de Acerto</div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeStats() {
            document.getElementById('stats-modal').style.display = 'none';
        }

        // üíæ Salvar/Carregar dados
        function saveGameStats() {
            const stats = {
                score: gameState.score,
                correctAnswers: gameState.correctAnswers,
                totalAttempts: gameState.totalAttempts,
                lastPlayed: new Date().toISOString()
            };
            localStorage.setItem('spaceshipGameStats', JSON.stringify(stats));
        }

        // üîÑ Fun√ß√µes utilit√°rias
        function updateScoreDisplay() {
            document.getElementById('current-score').textContent = gameState.score;
            document.getElementById('correct-answers').textContent = gameState.correctAnswers;
            document.getElementById('total-attempts').textContent = gameState.totalAttempts;
        }

        function resetFeedback() {
            document.getElementById('feedback-section').style.display = 'none';
            document.getElementById('details-section').style.display = 'none';
            document.getElementById('hints-container').style.display = 'none';
            document.getElementById('hints-list').innerHTML = '';
            document.getElementById('show-hint').style.display = 'block';
        }
    </script>
</body>
</html>